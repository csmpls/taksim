<!doctype html>
<html>
  <head>
    <link href="/css/style.css" rel="stylesheet" type="text/css">


    <script type="text/javascript">
    
    function resizeCanvas()
    {
        Processing.getInstanceById("taskcanvas").size(window.innerWidth, window.innerHeight);
    }
    </script>




    </head>
  	<body onresize="resizeCanvas();" style="margin: 0;padding: 0;">

  		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
		<script src="http://cloud.github.com/downloads/processing-js/processing-js/processing-1.4.1.js"></script>
		<script type="text/javascript" src="http://www.myersdaily.org/joseph/javascript/md5.js"></script>
		<script type="text/javascript" src="rtm.js"></script>

		<script type="text/javascript">


$(document).ready(function(){
	var api_key = '7c23ed1a5859cb852a5a09c3047325f6',
	    api_secret = '4bbb37c4885966bb',
	    checkPopup,
	    popup,
	    token,
	    frob;

	window.rtm = new RememberTheMilk(api_key, api_secret, 'delete');

	rtm.get('rtm.auth.getFrob', function(resp){
		$('#auth').attr('disabled', null);
		frob = resp.rsp.frob;
	});

	$('#auth').click(function(){
		var authUrl = rtm.getAuthUrl(frob);
		popup = window.open(authUrl);

		checkPopup = setInterval(function(){
			if (popup.closed == true) {
				clearInterval(checkPopup);

				rtm.get('rtm.auth.getToken', {frob: frob}, function(resp){
					rtm.auth_token = resp.rsp.auth.token;

					loadLists();
				});
			}
		}, 200);
	})
});





var loadLists = function(){
	$('#auth').hide();

	rtm.get('rtm.lists.getList', function(resp){
		$.each(resp.rsp.lists.list, function(index, list){
			$('<button>').html(list.name).data({
				id: list.id
			}).addClass('list')
			.appendTo($('#lists'));
		});

		$('button.list').click(function(){
			$('#tasks').html('Loading...');
			var listId = $(this).data('id');

			rtm.get('rtm.tasks.getList', {list_id: listId, filter: 'status:incomplete'}, function(resp){
				$('#tasks').empty();

				if (!resp.rsp.tasks || !resp.rsp.tasks.list) {
					$('#tasks').html('No tasks!');
					return;
				}

				$.each(resp.rsp.tasks.list, function(index, listItem){
					if (Object.prototype.toString.call(listItem.taskseries) != '[object Array]') {
						listItem.taskseries = [listItem.taskseries];
					}

					var pjs = Processing.getInstanceById("taskcanvas");

					pjs.clearTasks()

					$.each(listItem.taskseries, function(index, task){
						pjs.addTask(task.name)	

					})
					pjs.setup_urgents()
				});
			})
		})
	});
}
</script>
</script>

<script type="text/processing" data-processing-target="taskcanvas">

ArrayList tasks = new ArrayList<Task>();
int scroll = 0;

ArrayList<String> urgents = new ArrayList<String>();
String current_urgents[];
int last_urgent = 0;

void setup()
{
  size(screenWidth,screenHeight);
}

void draw() {

	background(0);
	pad = 30;


  // scroll tasks down side	
  int y = tasks.size() * -30;
  for (int i = 0; i < tasks.size(); i++) {
    t = tasks.get(i);
    t.draw(pad,scroll+y)
    y+=30;
  }   
  scroll++;


  // // display urgent tasks 
  // int u_y = 50;
  // for (int i = 0; i<current_urgents.length; i++) {
  //   fill(255,0,0);
  //   textSize(24);
  //   text(current_urgents[i], 350, u_y);
  //   u_y +=48;
  // }


  // check if topmost task is at bottom of the screen
  if (tasks.size() * -30 + scroll > height) {
    scroll = 0;
    tasks = shuffle(tasks);
  }

}

void addTask(String task_name) {
	tasks.add(new Task(task_name));
}

void clearTasks() {
	tasks = new ArrayList<Task>();
}

void setup_urgents() {
	for (int i = 0; i < tasks.size(); i++) {
		urgents.add((String)tasks.get(i).name);
	}

	pick_current_urgents();
}

void pick_current_urgents() {
	int l = (int)random(1,4);

	current_urgents = new String[l];

	// if we're about to overflow,
	// save the rest of the list to current_urgents
	// and reset
	if (last_urgent + l >= urgents.size()) {
    l = urgents.size() - last_urgent;
    current_urgents = new String[l];

    for (int i = 0; i < l; i++) {
      current_urgents[i] = urgents.get(last_urgent+i);
    }
    
    last_urgent = 0;
    
  } else {
    for (int i = 0; i < l; i++) {
      current_urgents[i] = urgents.get(last_urgent+i);
    }
  }

  println(current_urgents.length);
  
  last_urgent += l;
}

void keyPressed() {
  pick_current_urgents();
}

//shuffles list in-place
ArrayList shuffle(ArrayList list) {
  int i, j;
  Task t;
  for (i = 1; i < list.size(); i++) {
    randomSeed(millis());
    j = (int)random(0,i+1);  // choose j in [0..i]
    if (j != i) {
      t = (Task)list.get(i);                        // swap list[i] and list[j]
      list.set(i, list.get(j));
      list.set(j, t);
    }
  }
  return list;
}

public class Task {
	String name;

	Task(String _name) {
		name = _name;
	}

	void draw(int x, int y) {
		fill(192);
		text(name,x,y);
	}
}

</script>

<button id="auth" disabled="disabled">Login with Remember The Milk!</button>

<div id="lists"></div>
<div id="tasks"></div>

 
 <canvas id="taskcanvas" width="800px" height="300" ></canvas>



  	</body>

</html>
